<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TO-DO LIST</title>
    <link rel="stylesheet" href="/static/style.css?v=2">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <div class="container">
        <div class="calendar-section">
            <div class="calendar-header">
                <button id="prev-month" class="nav-btn">‹</button>
                <h2 id="current-month"></h2>
                <button id="next-month" class="nav-btn">›</button>
            </div>
            <div id="calendar" class="calendar">
                <div class="calendar-days"></div>
                <div class="calendar-dates"></div>
            </div>
        </div>

        <div class="todo-section">
            <h3 id="selected-date-title">날짜를 선택하세요</h3>
            <ul id="todo-list" class="todo-list"></ul>
            <form id="todo-form" class="todo-form" style="display: none;">
                <input type="text" id="title" placeholder="투두 제목" required>
                <input type="text" id="description" placeholder="설명" required>
                <button type="submit">투두 추가</button>
            </form>
        </div>
    </div>
    <script>
        let currentDate = new Date();
        let selectedDate = null;
        let allTodos = [];

        function initCalendar() {
            updateCalendarHeader();
            renderCalendar();
            loadAllTodos();
        }

        function updateCalendarHeader() {
            const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', 
                              '7월', '8월', '9월', '10월', '11월', '12월'];
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('current-month').textContent = `${year}년 ${monthNames[month]}`;
        }

    function renderCalendar() {
        const calendarDays = document.querySelector('.calendar-days');
        const calendarDates = document.querySelector('.calendar-dates');
        calendarDays.innerHTML = '';
        calendarDates.innerHTML = '';

        const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
        dayNames.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-header';
            dayHeader.textContent = day;
            calendarDays.appendChild(dayHeader);
        });

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        for (let i = 0; i < 42; i++) {
            const cellDate = new Date(startDate);
            cellDate.setDate(startDate.getDate() + i);

            const cell = document.createElement('div');
            cell.className = 'calendar-cell';
            cell.textContent = cellDate.getDate();

            if (cellDate.getMonth() === month) {
                cell.classList.add('current-month');
            } else {
                cell.classList.add('other-month');
            }

            if (cellDate.toDateString() === new Date().toDateString()) {
                cell.classList.add('today');
            }

            if (selectedDate && cellDate.toDateString() === selectedDate.toDateString()) {
                cell.classList.add('selected');
            }

            const dateStr = formatDate(cellDate);
            if (allTodos.some(todo => todo.date === dateStr)) {
                cell.classList.add('has-todos');
            }

            cell.addEventListener('click', () => selectDate(cellDate));
            calendarDates.appendChild(cell);
        }
    }


        function selectDate(date) {
            selectedDate = date;
            const dateStr = formatDate(date);
            document.getElementById('selected-date-title').textContent = 
                `${date.getFullYear()}년 ${date.getMonth() + 1}월 ${date.getDate()}일`;
            document.getElementById('todo-form').style.display = 'block';
            fetchTodosByDate(dateStr);
            renderCalendar();
        }

        function formatDate(date) {
            return date.getFullYear() + '-' + 
                   String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(date.getDate()).padStart(2, '0');
        }

        async function loadAllTodos() {
            try {
                const response = await fetch('/todos');
                allTodos = await response.json();
                renderCalendar();
            } catch (error) {
                console.error('TO-DO loading failed:', error);
            }
        }

        async function fetchTodosByDate(date) {
            try {
                const response = await fetch(`/todos/${date}`);
                const data = await response.json();
                displayTodos(data.todos);
            } catch (error) {
                console.error('Fetching TO-DO failed:', error);
                displayTodos([]);
            }
        }

        function displayTodos(todos) {
            const todoList = document.getElementById('todo-list');
            todoList.innerHTML = '';

            if (todos.length === 0) {
                todoList.innerHTML = '<li class="no-todos">No TO-DO</li>';
                return;
            }

            todos.forEach(todo => {
                const li = document.createElement('li');
                li.className = 'todo-item';

                li.innerHTML = `
                    <div>
                        <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''}>
                        <span class="todo-text">
                            <strong>${todo.title}</strong> - ${todo.description}
                        </span>
                        <span class="status ${todo.completed ? 'completed' : ''}">
                            ${todo.completed ? 'Done!' : ''}
                        </span>
                    </div>
                    <div class="button-group">
                        <button class="edit-btn">수정</button>
                        <button class="delete-btn">삭제</button>
                    </div>
                `;

                const checkbox = li.querySelector('.todo-checkbox');
                checkbox.addEventListener('change', async () => {
                    await updateTodo(todo.id, {
                        ...todo,
                        completed: checkbox.checked
                    });
                });

                const editButton = li.querySelector('.edit-btn');
                editButton.addEventListener('click', () => editTodo(todo));

                const deleteButton = li.querySelector('.delete-btn');
                deleteButton.addEventListener('click', () => deleteTodo(todo.id));

                todoList.appendChild(li);
            });
        }

        async function updateTodo(id, updatedTodo) {
            try {
                const response = await fetch(`/todos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedTodo)
                });
                if (response.ok) {
                    await loadAllTodos();
                    if (selectedDate) {
                        fetchTodosByDate(formatDate(selectedDate));
                    }
                }
            } catch (error) {
                console.error('투두 업데이트 실패:', error);
            }
        }

        async function editTodo(todo) {
            const title = prompt('새로운 투두 제목:', todo.title);
            if (title === null) return;
            
            const description = prompt('새로운 설명:', todo.description);
            if (description === null) return;
            
            const completed = confirm('이 작업이 완료되었나요?');
            
            await updateTodo(todo.id, {
                ...todo,
                title,
                description,
                completed
            });
        }

        async function deleteTodo(id) {
            if (!confirm('정말로 이 투두를 삭제하시겠습니까?')) return;
            
            try {
                const response = await fetch(`/todos/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    await loadAllTodos();
                    if (selectedDate) {
                        fetchTodosByDate(formatDate(selectedDate));
                    }
                }
            } catch (error) {
                console.error('Deleting TO-DO failed:', error);
            }
        }

        document.getElementById('todo-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!selectedDate) return;

            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            
            try {
                const response = await fetch('/todos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: Date.now(),
                        title,
                        description,
                        completed: false,
                        date: formatDate(selectedDate)
                    })
                });
                
                if (response.ok) {
                    document.getElementById('todo-form').reset();
                    await loadAllTodos();
                    fetchTodosByDate(formatDate(selectedDate));
                }
            } catch (error) {
                console.error('Adding TO-DO failed:', error);
            }
        });

        document.getElementById('prev-month').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateCalendarHeader();
            renderCalendar();
        });

        document.getElementById('next-month').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateCalendarHeader();
            renderCalendar();
        });
        initCalendar();
    </script>
</body>
</html>
